# Internationalization (i18n)

Multi-language support strategy for Caliber.

## Table of Contents

- [Overview](#overview)
- [Implementation Strategy](#implementation-strategy)
- [Setup](#setup)
- [Usage Patterns](#usage-patterns)
- [Translation Files Structure](#translation-files-structure)
- [Adding a New Language](#adding-a-new-language)
- [RTL Support](#rtl-support)
- [Date & Number Formatting](#date--number-formatting)
- [Database Considerations](#database-considerations)

---

## Overview

Caliber uses **next-intl** for internationalization, providing:

- Server and client component support
- Type-safe translations
- Automatic locale detection
- URL-based locale routing (`/en/admin/employees`, `/es/admin/employees`)

**Default Languages:**
- English (en) — Default
- Spanish (es) — Common in US manufacturing
- French (fr) — Canada support
- German (de) — EU support
- Simplified Chinese (zh-CN) — Global manufacturing

---

## Implementation Strategy

### Routing Strategy: Prefix-based

```
/en/admin/employees    → English
/es/admin/employees    → Spanish
/admin/employees       → Redirects to detected/default locale
```

### What Gets Translated

| Content Type | Translated | Notes |
|--------------|------------|-------|
| UI labels, buttons | ✅ Yes | All static text |
| Error messages | ✅ Yes | User-facing errors |
| Skill names | ❌ No | User-created content |
| Employee names | ❌ No | Personal data |
| Audit log actions | ✅ Yes | Display labels only |
| Email templates | ✅ Yes | Notification emails |

---

## Setup

### 1. Install Dependencies

```bash
bun add next-intl
```

### 2. Configure `next.config.js`

```javascript
// next.config.js
const withNextIntl = require('next-intl/plugin')('./src/i18n.ts');

/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
};

module.exports = withNextIntl(nextConfig);
```

### 3. Create i18n Configuration

```typescript
// src/i18n.ts
import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';

export const locales = ['en', 'es', 'fr', 'de', 'zh-CN'] as const;
export const defaultLocale = 'en' as const;

export type Locale = (typeof locales)[number];

export default getRequestConfig(async ({ locale }) => {
  if (!locales.includes(locale as Locale)) notFound();

  return {
    messages: (await import(`./messages/${locale}.json`)).default,
    timeZone: 'UTC', // Override per-user if needed
  };
});
```

### 4. Create Middleware

```typescript
// src/middleware.ts
import createMiddleware from 'next-intl/middleware';
import { locales, defaultLocale } from './i18n';

export default createMiddleware({
  locales,
  defaultLocale,
  localePrefix: 'as-needed', // Only prefix non-default locales
});

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)'],
};
```

### 5. Update App Structure

```
src/app/
├── [locale]/
│   ├── layout.tsx          # Locale-aware root layout
│   ├── page.tsx            # Home page
│   ├── (public)/
│   │   └── b/[badgeToken]/ # Public badge viewer
│   ├── admin/
│   │   ├── employees/
│   │   ├── skills/
│   │   └── matrix/
│   └── login/
├── api/                    # API routes (not localized)
└── not-found.tsx
```

---

## Usage Patterns

### Server Components

```tsx
// src/app/[locale]/admin/employees/page.tsx
import { useTranslations } from 'next-intl';

export default function EmployeesPage() {
  const t = useTranslations('employees');

  return (
    <div>
      <h1>{t('title')}</h1>
      <button>{t('actions.add')}</button>
    </div>
  );
}
```

### Client Components

```tsx
'use client';
import { useTranslations } from 'next-intl';

export function EmployeeForm() {
  const t = useTranslations('employees.form');

  return (
    <form>
      <label>{t('name')}</label>
      <input placeholder={t('namePlaceholder')} />
      <button type="submit">{t('submit')}</button>
    </form>
  );
}
```

### Dynamic Values

```tsx
// Usage: t('greeting', { name: 'John' })
// Message: "Hello, {name}!"
const message = t('greeting', { name: employee.name });

// Pluralization
// Message: "{count, plural, =0 {No skills} one {# skill} other {# skills}}"
const skillCount = t('skillCount', { count: skills.length });
```

### Formatted Dates

```tsx
import { useFormatter } from 'next-intl';

function CertificationDate({ date }: { date: Date }) {
  const format = useFormatter();
  
  return (
    <time dateTime={date.toISOString()}>
      {format.dateTime(date, { dateStyle: 'medium' })}
    </time>
  );
}
```

---

## Translation Files Structure

```
src/messages/
├── en.json
├── es.json
├── fr.json
├── de.json
└── zh-CN.json
```

### Example: `en.json`

```json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "search": "Search...",
    "loading": "Loading...",
    "noResults": "No results found",
    "actions": "Actions"
  },
  "nav": {
    "dashboard": "Dashboard",
    "employees": "Employees",
    "skills": "Skills",
    "matrix": "Skill Matrix",
    "users": "Users",
    "reports": "Reports",
    "settings": "Settings"
  },
  "employees": {
    "title": "Employees",
    "subtitle": "{count, plural, =0 {No employees} one {# employee} other {# employees}}",
    "actions": {
      "add": "Add Employee",
      "import": "Import CSV",
      "export": "Export"
    },
    "form": {
      "name": "Full Name",
      "namePlaceholder": "Enter employee name",
      "employeeNumber": "Employee Number",
      "site": "Site",
      "department": "Department",
      "role": "Role",
      "email": "Email (optional)",
      "submit": "Create Employee"
    },
    "status": {
      "active": "Active",
      "terminated": "Terminated",
      "leave": "On Leave"
    },
    "badge": {
      "download": "Download Badge QR",
      "regenerate": "Regenerate Badge Token",
      "regenerateConfirm": "This will invalidate the current badge. Continue?"
    }
  },
  "skills": {
    "title": "Skills Catalog",
    "add": "Add Skill",
    "revisions": "Revisions",
    "status": {
      "draft": "Draft",
      "active": "Active",
      "archived": "Archived"
    },
    "validity": {
      "never": "Never expires",
      "months": "{count, plural, one {# month} other {# months}}"
    }
  },
  "matrix": {
    "title": "Skill Matrix",
    "filters": {
      "site": "Filter by Site",
      "department": "Filter by Department",
      "skill": "Filter by Skill"
    },
    "legend": {
      "valid": "Valid",
      "expiringSoon": "Expiring Soon",
      "missing": "Missing",
      "outdated": "Outdated",
      "insufficientLevel": "Insufficient Level"
    },
    "export": "Export to CSV"
  },
  "gapAnalysis": {
    "status": {
      "VALID": "Valid",
      "MISSING": "Missing",
      "OUTDATED": "Outdated Revision",
      "EXPIRING_SOON": "Expiring Soon",
      "INSUFFICIENT_LEVEL": "Insufficient Level"
    }
  },
  "certification": {
    "certify": "Certify",
    "revoke": "Revoke Certification",
    "revokeReason": "Reason for revocation",
    "revokeConfirm": "This will invalidate the employee's certification. Continue?",
    "certifiedBy": "Certified by {name}",
    "certifiedOn": "Certified on {date}",
    "expiresOn": "Expires {date}",
    "level": "Level {achieved}/{max}"
  },
  "badge": {
    "publicTitle": "{name}'s Qualifications",
    "scanDate": "Scanned on {date}",
    "noSkills": "No certifications on record"
  },
  "errors": {
    "generic": "Something went wrong. Please try again.",
    "notFound": "Page not found",
    "unauthorized": "You don't have permission to access this.",
    "sessionExpired": "Your session has expired. Please log in again.",
    "validation": "Please check your input and try again.",
    "network": "Network error. Check your connection."
  },
  "auth": {
    "login": "Log In",
    "logout": "Log Out",
    "email": "Email",
    "password": "Password",
    "forgotPassword": "Forgot password?",
    "invalidCredentials": "Invalid email or password"
  }
}
```

### Example: `es.json` (partial)

```json
{
  "common": {
    "save": "Guardar",
    "cancel": "Cancelar",
    "delete": "Eliminar",
    "edit": "Editar",
    "search": "Buscar...",
    "loading": "Cargando...",
    "noResults": "No se encontraron resultados",
    "actions": "Acciones"
  },
  "nav": {
    "dashboard": "Panel",
    "employees": "Empleados",
    "skills": "Habilidades",
    "matrix": "Matriz de Habilidades",
    "users": "Usuarios",
    "reports": "Informes",
    "settings": "Configuración"
  },
  "employees": {
    "title": "Empleados",
    "subtitle": "{count, plural, =0 {Sin empleados} one {# empleado} other {# empleados}}",
    "actions": {
      "add": "Agregar Empleado",
      "import": "Importar CSV",
      "export": "Exportar"
    }
  }
}
```

---

## Adding a New Language

1. **Create translation file:**
   ```bash
   cp src/messages/en.json src/messages/pt-BR.json
   ```

2. **Add to locales array:**
   ```typescript
   // src/i18n.ts
   export const locales = ['en', 'es', 'fr', 'de', 'zh-CN', 'pt-BR'] as const;
   ```

3. **Translate content:**
   - Use professional translators for accuracy
   - Test with native speakers
   - Pay attention to text expansion (German text is ~30% longer than English)

4. **Test thoroughly:**
   - Check all pages render correctly
   - Verify pluralization rules
   - Check date/number formatting

---

## RTL Support

For Arabic, Hebrew, or other RTL languages:

```typescript
// src/lib/i18n/direction.ts
export const rtlLocales = ['ar', 'he'] as const;

export function getDirection(locale: string): 'ltr' | 'rtl' {
  return rtlLocales.includes(locale as typeof rtlLocales[number]) ? 'rtl' : 'ltr';
}
```

```tsx
// src/app/[locale]/layout.tsx
import { getDirection } from '@/lib/i18n/direction';

export default function LocaleLayout({
  children,
  params: { locale },
}: {
  children: React.ReactNode;
  params: { locale: string };
}) {
  return (
    <html lang={locale} dir={getDirection(locale)}>
      <body>{children}</body>
    </html>
  );
}
```

---

## Date & Number Formatting

### Date Formatting by Locale

```tsx
import { useFormatter } from 'next-intl';

function FormattedDate({ date }: { date: Date }) {
  const format = useFormatter();
  
  // Automatically uses locale-appropriate format
  // en: "Jan 15, 2026"
  // de: "15. Jan. 2026"
  // zh-CN: "2026年1月15日"
  return format.dateTime(date, { dateStyle: 'medium' });
}
```

### Relative Time

```tsx
function TimeAgo({ date }: { date: Date }) {
  const format = useFormatter();
  
  // "2 days ago", "hace 2 días", "vor 2 Tagen"
  return format.relativeTime(date);
}
```

### Number Formatting

```tsx
function FormattedNumber({ value }: { value: number }) {
  const format = useFormatter();
  
  // en: "1,234.56"
  // de: "1.234,56"
  return format.number(value);
}
```

---

## Database Considerations

### User Locale Preference

Add to users table:

```typescript
// src/db/schema.ts
export const users = pgTable('users', {
  // ... existing fields
  preferredLocale: text('preferred_locale').default('en'),
});
```

### Locale in Session

```typescript
// src/lib/auth/session.ts
export async function getSession() {
  const session = await auth();
  return {
    ...session,
    locale: session?.user?.preferredLocale ?? 'en',
  };
}
```

### Audit Log Localization

Audit logs store action keys, not translated strings:

```typescript
// Stored in DB
{ action: 'create', entityType: 'employee' }

// Displayed with translation
t(`auditActions.${log.action}`)  // "Created" / "Creado" / "Erstellt"
```

---

## Testing Translations

### Pseudo-localization

For testing, create a pseudo-locale that adds markers:

```typescript
// scripts/generate-pseudo-locale.ts
function pseudoLocalize(text: string): string {
  return `[${text.replace(/[aeiou]/g, char => char + char)}]`;
}
// "Save" → "[Saavee]"
```

This helps identify:
- Hardcoded strings (missing `[ ]` markers)
- Text overflow issues (pseudo text is longer)

### Missing Translation Detection

```typescript
// next-intl.config.ts
export default {
  onError(error) {
    if (error.code === 'MISSING_MESSAGE') {
      console.warn(`Missing translation: ${error.key}`);
      // In dev, show key; in prod, fallback to English
      return process.env.NODE_ENV === 'development' 
        ? `⚠️ ${error.key}` 
        : error.key.split('.').pop();
    }
  },
};
```

---

## Roadmap Checklist

- [ ] Install `next-intl`
- [ ] Create i18n configuration
- [ ] Set up middleware for locale detection
- [ ] Restructure app directory for `[locale]`
- [ ] Create English translation file (complete)
- [ ] Create Spanish translation file
- [ ] Add locale preference to user settings
- [ ] Update all components to use `useTranslations`
- [ ] Add language switcher component
- [ ] Test all pages in each language
- [ ] Add date/number formatting
- [ ] Document translation workflow for non-developers
